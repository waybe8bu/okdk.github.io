<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>TrinityCore ç©å®¶ç§»åŠ¨ä¿¡æ¯çš„å¹¿æ’­æœºåˆ¶ | okie dokie</title>
    <link rel="stylesheet" href="/css/style.css" />
    <link rel="stylesheet" href="/css/fonts.css" />
    
  </head>

  <body>
    <nav>
    <ul class="menu">
      
      <li><a href="/">Home</a></li>
      
      <li><a href="/posts">All posts</a></li>
      
    </ul>
    <hr/>
    </nav>

<div class="article-meta">
<h1><span class="title">TrinityCore ç©å®¶ç§»åŠ¨ä¿¡æ¯çš„å¹¿æ’­æœºåˆ¶</span></h1>

<h2 class="date">2024/01/09</h2>
</div>

<main>
<p>åˆ†æTrinityCore-3.3.5ä¸‹çš„ä»£ç ï¼Œè§£é‡ŠæœåŠ¡ç«¯æ˜¯åœ¨å“ªäº›æ—¶æœºä»¥åŠå¦‚ä½•åŒæ­¥æŸä¸ªç©å®¶çš„ç§»åŠ¨ä¿¡æ¯ç»™å‘¨å›´ç©å®¶çš„</p>
<p>æˆ‘æ¥å¸®ä½ åˆ†æTrinityCore-3.3.5æœåŠ¡ç«¯æ˜¯å¦‚ä½•åŒæ­¥ç©å®¶ç§»åŠ¨ä¿¡æ¯çš„ã€‚è®©æˆ‘æ·±å…¥æŸ¥çœ‹ç›¸å…³ä»£ç ï¼š ç°åœ¨è®©æˆ‘æŸ¥çœ‹ç§»åŠ¨å¤„ç†çš„æ ¸å¿ƒéƒ¨åˆ†ï¼š è®©æˆ‘ç»§ç»­æŸ¥çœ‹ç§»åŠ¨å¤„ç†çš„å…³é”®éƒ¨åˆ†ï¼Œç‰¹åˆ«æ˜¯å¦‚ä½•å¹¿æ’­ç»™å‘¨å›´ç©å®¶ï¼š ç°åœ¨è®©æˆ‘æŸ¥çœ‹SendMessageToSetæ–¹æ³•çš„å®ç°ï¼š ç°åœ¨è®©æˆ‘æŸ¥çœ‹æ¶ˆæ¯åˆ†å‘å™¨çš„å®ç°ï¼š ç°åœ¨è®©æˆ‘æŸ¥çœ‹Gridç³»ç»Ÿçš„å®ç°ï¼š è®©æˆ‘æŸ¥çœ‹MessageDistDelivererçš„Visitå®ç°ï¼š ç°åœ¨è®©æˆ‘æŸ¥çœ‹å¯è§è·ç¦»çš„å®šä¹‰ï¼š ç°åœ¨è®©æˆ‘æŸ¥çœ‹åœ°å›¾çš„å¯è§è·ç¦»é…ç½®ï¼š ç°åœ¨è®©æˆ‘æ•´ç†åˆ†æç»“æœã€‚æ ¹æ®æˆ‘å¯¹TrinityCore-3.3.5ä»£ç çš„æ·±å…¥åˆ†æï¼Œæˆ‘æ¥è¯¦ç»†è§£é‡ŠæœåŠ¡ç«¯å¦‚ä½•åŒæ­¥ç©å®¶ç§»åŠ¨ä¿¡æ¯ï¼š</p>
<h2 id="trinitycore-335-ç§»åŠ¨åŒæ­¥æœºåˆ¶åˆ†æ">TrinityCore-3.3.5 ç§»åŠ¨åŒæ­¥æœºåˆ¶åˆ†æ</h2>
<h3 id="-æ ¸å¿ƒåŒæ­¥æ—¶æœº">ğŸ¯ æ ¸å¿ƒåŒæ­¥æ—¶æœº</h3>
<h4 id="1-ç©å®¶ç§»åŠ¨æ•°æ®æ¥æ”¶å¤„ç†">1. <strong>ç©å®¶ç§»åŠ¨æ•°æ®æ¥æ”¶å¤„ç†</strong></h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#75715e">// ä½ç½®ï¼šMovementHandler.cpp::HandleMovementOpcodes()
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">void</span> WorldSession<span style="color:#f92672">::</span>HandleMovementOpcodes(WorldPacket<span style="color:#f92672">&amp;</span> recvPacket)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 1. éªŒè¯ç§»åŠ¨æ•°æ®æœ‰æ•ˆæ€§
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    MovementInfo movementInfo;
</span></span><span style="display:flex;"><span>    ReadMovementInfo(recvPacket, <span style="color:#f92672">&amp;</span>movementInfo);
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 2. æ—¶é—´åŒæ­¥å¤„ç†
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    int64 movementTime <span style="color:#f92672">=</span> (int64) movementInfo.time <span style="color:#f92672">+</span> _timeSyncClockDelta;
</span></span><span style="display:flex;"><span>    movementInfo.time <span style="color:#f92672">=</span> (uint32)movementTime;
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 3. é‡æ–°æ‰“åŒ…ç§»åŠ¨æ•°æ®
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    WorldPacket <span style="color:#a6e22e">data</span>(opcode, recvPacket.size());
</span></span><span style="display:flex;"><span>    movementInfo.guid <span style="color:#f92672">=</span> mover<span style="color:#f92672">-&gt;</span>GetGUID();
</span></span><span style="display:flex;"><span>    WriteMovementInfo(<span style="color:#f92672">&amp;</span>data, <span style="color:#f92672">&amp;</span>movementInfo);
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 4. å¹¿æ’­ç»™å‘¨å›´ç©å®¶ - å…³é”®æ­¥éª¤
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    mover<span style="color:#f92672">-&gt;</span>SendMessageToSet(<span style="color:#f92672">&amp;</span>data, _player);
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 5. æ›´æ–°æœåŠ¡å™¨ç«¯ä½ç½®
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    mover<span style="color:#f92672">-&gt;</span>m_movementInfo <span style="color:#f92672">=</span> movementInfo;
</span></span><span style="display:flex;"><span>    mover<span style="color:#f92672">-&gt;</span>UpdatePosition(movementInfo.pos);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h4 id="2-æœåŠ¡å™¨ä¸»åŠ¨ç§»åŠ¨åŒæ­¥">2. <strong>æœåŠ¡å™¨ä¸»åŠ¨ç§»åŠ¨åŒæ­¥</strong></h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#75715e">// ä½ç½®ï¼šUnit.cpp::UpdateSplineMovement()
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">void</span> Unit<span style="color:#f92672">::</span>UpdateSplineMovement(uint32 t_diff)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Splineç§»åŠ¨çš„å®šæœŸåŒæ­¥
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> (movespline<span style="color:#f92672">-&gt;</span>isCyclic())
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        m_splineSyncTimer.Update(t_diff);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (m_splineSyncTimer.Passed())
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            m_splineSyncTimer.Reset(<span style="color:#ae81ff">5000</span>); <span style="color:#75715e">// æ¯5ç§’åŒæ­¥ä¸€æ¬¡
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            
</span></span><span style="display:flex;"><span>            WorldPacket <span style="color:#a6e22e">data</span>(SMSG_FLIGHT_SPLINE_SYNC, <span style="color:#ae81ff">4</span> <span style="color:#f92672">+</span> GetPackGUID().size());
</span></span><span style="display:flex;"><span>            Movement<span style="color:#f92672">::</span>PacketBuilder<span style="color:#f92672">::</span>WriteSplineSync(<span style="color:#f92672">*</span>movespline, data);
</span></span><span style="display:flex;"><span>            data.appendPackGUID(GetGUID());
</span></span><span style="display:flex;"><span>            SendMessageToSet(<span style="color:#f92672">&amp;</span>data, true); <span style="color:#75715e">// å¹¿æ’­ç»™å‘¨å›´ç©å®¶
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="-åŒæ­¥è§¦å‘æ¡ä»¶">ğŸ”„ åŒæ­¥è§¦å‘æ¡ä»¶</h3>
<p>TrinityCoreåœ¨ä»¥ä¸‹æƒ…å†µä¸‹ä¼šåŒæ­¥ç§»åŠ¨ä¿¡æ¯ï¼š</p>
<h4 id="a-å®¢æˆ·ç«¯ä¸»åŠ¨ç§»åŠ¨">A. <strong>å®¢æˆ·ç«¯ä¸»åŠ¨ç§»åŠ¨</strong></h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">è§¦å‘æ¶ˆæ¯ç±»å‹</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">-</span> MSG_MOVE_START_FORWARD<span style="color:#f92672">/</span>BACKWARD  <span style="color:#75715e">// å¼€å§‹å‰è¿›/åé€€
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#f92672">-</span> MSG_MOVE_START_STRAFE_LEFT<span style="color:#f92672">/</span>RIGHT <span style="color:#75715e">// å¼€å§‹å¹³ç§»
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#f92672">-</span> MSG_MOVE_START_TURN_LEFT<span style="color:#f92672">/</span>RIGHT   <span style="color:#75715e">// å¼€å§‹è½¬å‘
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#f92672">-</span> MSG_MOVE_STOP                    <span style="color:#75715e">// åœæ­¢ç§»åŠ¨
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#f92672">-</span> MSG_MOVE_JUMP                    <span style="color:#75715e">// è·³è·ƒ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#f92672">-</span> MSG_MOVE_FALL_LAND              <span style="color:#75715e">// ç€é™†
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#f92672">-</span> MSG_MOVE_SET_FACING             <span style="color:#75715e">// è®¾ç½®æœå‘
</span></span></span></code></pre></div><h4 id="b-æœåŠ¡å™¨å¼ºåˆ¶ç§»åŠ¨">B. <strong>æœåŠ¡å™¨å¼ºåˆ¶ç§»åŠ¨</strong></h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#75715e">// ä¼ é€ã€å‡»é€€ã€æŠ€èƒ½ä½ç§»ç­‰
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>mover<span style="color:#f92672">-&gt;</span>SendMessageToSet(<span style="color:#f92672">&amp;</span>data, true);
</span></span></code></pre></div><h4 id="c-å®šæœŸåŒæ­¥-åä½œå¼Š">C. <strong>å®šæœŸåŒæ­¥ (åä½œå¼Š)</strong></h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#75715e">// Splineç§»åŠ¨æ¯5ç§’å¼ºåˆ¶åŒæ­¥ä¸€æ¬¡
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>m_splineSyncTimer.Reset(<span style="color:#ae81ff">5000</span>);
</span></span></code></pre></div><h3 id="-å¹¿æ’­èŒƒå›´å’Œæœºåˆ¶">ğŸ“¡ å¹¿æ’­èŒƒå›´å’Œæœºåˆ¶</h3>
<h4 id="1-sendmessagetoset-æ ¸å¿ƒæ–¹æ³•">1. <strong>SendMessageToSet æ ¸å¿ƒæ–¹æ³•</strong></h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#75715e">// ä½ç½®ï¼šObject.cpp
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">void</span> WorldObject<span style="color:#f92672">::</span>SendMessageToSet(WorldPacket <span style="color:#66d9ef">const</span><span style="color:#f92672">*</span> data, <span style="color:#66d9ef">bool</span> self) <span style="color:#66d9ef">const</span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (IsInWorld())
</span></span><span style="display:flex;"><span>        SendMessageToSetInRange(data, GetVisibilityRange(), self);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span> WorldObject<span style="color:#f92672">::</span>SendMessageToSetInRange(WorldPacket <span style="color:#66d9ef">const</span><span style="color:#f92672">*</span> data, <span style="color:#66d9ef">float</span> dist, <span style="color:#66d9ef">bool</span> <span style="color:#75715e">/*self*/</span>) <span style="color:#66d9ef">const</span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    Trinity<span style="color:#f92672">::</span>MessageDistDeliverer notifier(<span style="color:#66d9ef">this</span>, data, dist);
</span></span><span style="display:flex;"><span>    Cell<span style="color:#f92672">::</span>VisitWorldObjects(<span style="color:#66d9ef">this</span>, notifier, dist);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h4 id="2-è·ç¦»è®¡ç®—å’Œè¿‡æ»¤">2. <strong>è·ç¦»è®¡ç®—å’Œè¿‡æ»¤</strong></h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#75715e">// ä½ç½®ï¼šGridNotifiers.cpp::MessageDistDeliverer::Visit()
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">void</span> MessageDistDeliverer<span style="color:#f92672">::</span>Visit(PlayerMapType <span style="color:#f92672">&amp;</span>m)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> (PlayerMapType<span style="color:#f92672">::</span>iterator iter <span style="color:#f92672">=</span> m.begin(); iter <span style="color:#f92672">!=</span> m.end(); <span style="color:#f92672">++</span>iter)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        Player<span style="color:#f92672">*</span> target <span style="color:#f92672">=</span> iter<span style="color:#f92672">-&gt;</span>GetSource();
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 1. ç›¸ä½æ£€æŸ¥
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>target<span style="color:#f92672">-&gt;</span>InSamePhase(i_phaseMask))
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">continue</span>;
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 2. è·ç¦»æ£€æŸ¥ (2Dè·ç¦»)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span> (target<span style="color:#f92672">-&gt;</span>GetExactDist2dSq(i_source) <span style="color:#f92672">&gt;</span> i_distSq)
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">continue</span>;
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 3. å¯è§æ€§æ£€æŸ¥
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>target<span style="color:#f92672">-&gt;</span>HaveAtClient(i_source))
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 4. å‘é€æ•°æ®åŒ…
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        target<span style="color:#f92672">-&gt;</span>SendDirectMessage(i_message);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h4 id="3-å¯è§è·ç¦»é…ç½®">3. <strong>å¯è§è·ç¦»é…ç½®</strong></h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#75715e">// ä¸åŒåœ°å›¾ç±»å‹çš„å¯è§è·ç¦»
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#960050;background-color:#1e0010">æ™®é€šåœ°å›¾</span><span style="color:#f92672">:</span> World<span style="color:#f92672">::</span>GetMaxVisibleDistanceOnContinents()  <span style="color:#75715e">// é€šå¸¸ 90-120ç 
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#960050;background-color:#1e0010">å‰¯æœ¬</span><span style="color:#f92672">:</span>    World<span style="color:#f92672">::</span>GetMaxVisibleDistanceInInstances()   <span style="color:#75715e">// é€šå¸¸ 60-80ç   
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#960050;background-color:#1e0010">æˆ˜åœº</span><span style="color:#f92672">:</span>    World<span style="color:#f92672">::</span>GetMaxVisibleDistanceInBG()          <span style="color:#75715e">// é€šå¸¸ 100ç 
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#960050;background-color:#1e0010">ç«æŠ€åœº</span><span style="color:#f92672">:</span>  World<span style="color:#f92672">::</span>GetMaxVisibleDistanceInArenas()      <span style="color:#75715e">// é€šå¸¸ 40-60ç 
</span></span></span></code></pre></div><h3 id="-gridç³»ç»Ÿä¼˜åŒ–">ğŸ—‚ï¸ Gridç³»ç»Ÿä¼˜åŒ–</h3>
<h4 id="1-ç©ºé—´åˆ†å‰²">1. <strong>ç©ºé—´åˆ†å‰²</strong></h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#75715e">// TrinityCoreä½¿ç”¨Gridç³»ç»Ÿåˆ†å‰²åœ°å›¾ç©ºé—´
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// åªè®¿é—®ç§»åŠ¨ç©å®¶å‘¨å›´çš„Gridå•å…ƒæ ¼
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>Cell<span style="color:#f92672">::</span>VisitWorldObjects(<span style="color:#66d9ef">this</span>, notifier, dist);
</span></span></code></pre></div><h4 id="2-é«˜æ•ˆéå†">2. <strong>é«˜æ•ˆéå†</strong></h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#75715e">// ä¸æ˜¯éå†æ‰€æœ‰åœ¨çº¿ç©å®¶ï¼Œè€Œæ˜¯åªéå†é™„è¿‘Gridä¸­çš„ç©å®¶
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// å¤§å¤§å‡å°‘äº†CPUå¼€é”€
</span></span></span></code></pre></div><h3 id="-åŒæ­¥è¿‡æ»¤æ¡ä»¶">ğŸš« åŒæ­¥è¿‡æ»¤æ¡ä»¶</h3>
<p>æœåŠ¡å™¨<strong>ä¸ä¼š</strong>å‘ä»¥ä¸‹ç©å®¶å‘é€ç§»åŠ¨æ•°æ®ï¼š</p>
<h4 id="1-åŸºç¡€è¿‡æ»¤">1. <strong>åŸºç¡€è¿‡æ»¤</strong></h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#66d9ef">void</span> MessageDistDeliverer<span style="color:#f92672">::</span>SendPacket(Player<span style="color:#f92672">*</span> player)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// ä¸å‘é€ç»™è‡ªå·±
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> (player <span style="color:#f92672">==</span> i_source)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// é˜µè¥è¿‡æ»¤ (å¦‚æœå¯ç”¨)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> (team <span style="color:#f92672">&amp;&amp;</span> player<span style="color:#f92672">-&gt;</span>GetTeam() <span style="color:#f92672">!=</span> team)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// æŒ‡å®šè·³è¿‡çš„ç©å®¶
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> (skipped_receiver <span style="color:#f92672">==</span> player)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// å®¢æˆ·ç«¯æ²¡æœ‰è¯¥å¯¹è±¡çš„æ•°æ®
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>player<span style="color:#f92672">-&gt;</span>HaveAtClient(i_source))
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h4 id="2-è·ç¦»è¿‡æ»¤">2. <strong>è·ç¦»è¿‡æ»¤</strong></h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#75715e">// è¶…å‡ºå¯è§è·ç¦»çš„ç©å®¶ä¸æ¥æ”¶ç§»åŠ¨æ•°æ®
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">if</span> (target<span style="color:#f92672">-&gt;</span>GetExactDist2dSq(i_source) <span style="color:#f92672">&gt;</span> i_distSq)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">continue</span>;
</span></span></code></pre></div><h4 id="3-ç›¸ä½è¿‡æ»¤">3. <strong>ç›¸ä½è¿‡æ»¤</strong></h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#75715e">// ä¸åŒç›¸ä½çš„ç©å®¶äº’ç›¸ä¸å¯è§
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>target<span style="color:#f92672">-&gt;</span>InSamePhase(i_phaseMask))
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">continue</span>;
</span></span></code></pre></div><h3 id="-æ€§èƒ½ä¼˜åŒ–ç­–ç•¥">âš¡ æ€§èƒ½ä¼˜åŒ–ç­–ç•¥</h3>
<h4 id="1-æ•°æ®åŒ…å¤ç”¨">1. <strong>æ•°æ®åŒ…å¤ç”¨</strong></h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#75715e">// åŒä¸€ä¸ªç§»åŠ¨æ•°æ®åŒ…å¤ç”¨ç»™æ‰€æœ‰æ¥æ”¶è€…
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// é¿å…é‡å¤åºåˆ—åŒ–
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>WorldPacket <span style="color:#a6e22e">data</span>(opcode, recvPacket.size());
</span></span><span style="display:flex;"><span>WriteMovementInfo(<span style="color:#f92672">&amp;</span>data, <span style="color:#f92672">&amp;</span>movementInfo);
</span></span><span style="display:flex;"><span>mover<span style="color:#f92672">-&gt;</span>SendMessageToSet(<span style="color:#f92672">&amp;</span>data, _player);
</span></span></code></pre></div><h4 id="2-gridç©ºé—´ç´¢å¼•">2. <strong>Gridç©ºé—´ç´¢å¼•</strong></h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#75715e">// ä½¿ç”¨ç©ºé—´åˆ†å‰²é¿å…å…¨å±€éå†
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// åªæ£€æŸ¥ç§»åŠ¨å•ä½å‘¨å›´çš„Gridå•å…ƒæ ¼
</span></span></span></code></pre></div><h4 id="3-å¼‚æ­¥å‘é€">3. <strong>å¼‚æ­¥å‘é€</strong></h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#75715e">// ç½‘ç»œå‘é€æ˜¯å¼‚æ­¥çš„ï¼Œä¸é˜»å¡æ¸¸æˆå¾ªç¯
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>target<span style="color:#f92672">-&gt;</span>SendDirectMessage(i_message);
</span></span></code></pre></div><h3 id="-å®é™…æ‰§è¡Œæµç¨‹">ğŸ“Š å®é™…æ‰§è¡Œæµç¨‹</h3>
<h4 id="å®Œæ•´çš„ç§»åŠ¨åŒæ­¥æµç¨‹">å®Œæ•´çš„ç§»åŠ¨åŒæ­¥æµç¨‹ï¼š</h4>
<pre tabindex="0"><code>1. å®¢æˆ·ç«¯å‘é€ç§»åŠ¨åŒ… â†’ æœåŠ¡å™¨
2. æœåŠ¡å™¨éªŒè¯ç§»åŠ¨æ•°æ®æœ‰æ•ˆæ€§
3. æœåŠ¡å™¨æ—¶é—´åŒæ­¥å¤„ç†
4. é‡æ–°æ‰“åŒ…ç§»åŠ¨æ•°æ®
5. ç¡®å®šå¹¿æ’­èŒƒå›´ (GetVisibilityRange)
6. éå†èŒƒå›´å†…çš„Gridå•å…ƒæ ¼
7. å¯¹æ¯ä¸ªç©å®¶è¿›è¡Œè¿‡æ»¤æ£€æŸ¥ï¼š
   - è·ç¦»æ£€æŸ¥
   - ç›¸ä½æ£€æŸ¥  
   - å¯è§æ€§æ£€æŸ¥
   - é˜µè¥æ£€æŸ¥ (å¦‚é€‚ç”¨)
8. å‘ç¬¦åˆæ¡ä»¶çš„ç©å®¶å‘é€ç§»åŠ¨æ•°æ®åŒ…
9. æ›´æ–°æœåŠ¡å™¨ç«¯ç§»åŠ¨çŠ¶æ€
</code></pre><h3 id="-å…³é”®è¦ç‚¹æ€»ç»“">ğŸ¯ å…³é”®è¦ç‚¹æ€»ç»“</h3>
<ol>
<li><strong>äº‹ä»¶é©±åŠ¨</strong>: åªåœ¨ç§»åŠ¨çŠ¶æ€æ”¹å˜æ—¶åŒæ­¥ï¼Œä¸æ˜¯æ¯å¸§åŒæ­¥</li>
<li><strong>è·ç¦»ä¼˜åŒ–</strong>: åªå‘å¯è§è·ç¦»å†…çš„ç©å®¶å‘é€æ•°æ®</li>
<li><strong>Gridç³»ç»Ÿ</strong>: ç©ºé—´åˆ†å‰²é¿å…å…¨å±€éå†ï¼Œå¤§å¹…æå‡æ€§èƒ½</li>
<li><strong>æ™ºèƒ½è¿‡æ»¤</strong>: å¤šå±‚è¿‡æ»¤ç¡®ä¿åªå‘é€å¿…è¦çš„æ•°æ®</li>
<li><strong>æ•°æ®åŒ…å¤ç”¨</strong>: ä¸€æ¬¡æ„å»ºï¼Œå¤šæ¬¡å‘é€ï¼Œå‡å°‘CPUå¼€é”€</li>
<li><strong>å¼‚æ­¥ç½‘ç»œ</strong>: ç½‘ç»œå‘é€ä¸é˜»å¡æ¸¸æˆä¸»å¾ªç¯</li>
</ol>
<p>è¿™ç§è®¾è®¡ç¡®ä¿äº†å³ä½¿åœ¨é«˜å¹¶å‘æƒ…å†µä¸‹ï¼Œç§»åŠ¨åŒæ­¥ä¹Ÿèƒ½ä¿æŒé«˜æ•ˆç‡å’Œä½å»¶è¿Ÿã€‚</p>

</main>

  <footer>
  
  
  </footer>
  </body>
</html>

