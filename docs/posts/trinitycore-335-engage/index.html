<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>TrinityCore 如何处理怪物 Engage 玩家 | okie dokie</title>
    <link rel="stylesheet" href="/css/style.css" />
    <link rel="stylesheet" href="/css/fonts.css" />
    
  </head>

  <body>
    <nav>
    <ul class="menu">
      
      <li><a href="/">Home</a></li>
      
      <li><a href="/posts">All posts</a></li>
      
    </ul>
    <hr/>
    </nav>

<div class="article-meta">
<h1><span class="title">TrinityCore 如何处理怪物 Engage 玩家</span></h1>

<h2 class="date">2024/01/01</h2>
</div>

<main>
<p>分析TrinityCore-3.3.5下的代码，指出触发怪物将玩家设置为target的代码</p>
<p>我来帮你分析TrinityCore-3.3.5代码库中触发怪物将玩家设置为target的相关代码。首先让我了解一下代码结构。 现在让我搜索与怪物目标选择相关的代码，重点关注AI和Entities目录： 让我搜索更多关于AI和目标选择的代码： 现在让我查看更具体的AI文件来了解目标选择机制： 让我搜索更多关于目标选择的函数： 现在让我查看关键的<code>SelectVictim</code>和<code>EngageWithTarget</code>函数： 现在让我查看<code>EngageWithTarget</code>函数： 现在让我查看<code>AddThreat</code>函数，这是关键的函数： 让我继续阅读这个函数的关键部分： 现在让我查看与怪物最初激活攻击相关的代码： 现在让我查看<code>CanStartAttack</code>函数，这是决定怪物是否能开始攻击玩家的关键函数： 让我查看怪物AI更新的代码，了解怪物如何处理攻击目标： 让我查看怪物Creature类的Update方法： 现在让我查看一些常见的AI脚本，了解怪物如何选择和攻击目标： 基于我对TrinityCore 3.3.5代码的分析，我可以为你详细解释触发怪物将玩家设置为target的主要代码机制：</p>
<h2 id="trinitycore-335中怪物设置玩家为目标的代码分析">TrinityCore 3.3.5中怪物设置玩家为目标的代码分析</h2>
<h3 id="1-主要触发机制">1. 主要触发机制</h3>
<p>怪物将玩家设置为攻击目标主要通过以下几个关键代码路径：</p>
<h4 id="a-视线检测系统-moveinlineofsight">A. 视线检测系统 (<code>MoveInLineOfSight</code>)</h4>
<p><strong>文件</strong>: CreatureAI.cpp (第117行)</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#66d9ef">void</span> CreatureAI<span style="color:#f92672">::</span>MoveInLineOfSight(Unit<span style="color:#f92672">*</span> who)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (me<span style="color:#f92672">-&gt;</span>IsEngaged())
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (me<span style="color:#f92672">-&gt;</span>HasReactState(REACT_AGGRESSIVE) <span style="color:#f92672">&amp;&amp;</span> me<span style="color:#f92672">-&gt;</span>CanStartAttack(who, false))
</span></span><span style="display:flex;"><span>        me<span style="color:#f92672">-&gt;</span>EngageWithTarget(who);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>这是最基本的攻击触发机制，当玩家进入怪物的视线范围内时，如果怪物是攻击性反应状态，就会尝试攻击。</p>
<h4 id="b-怪物能否开始攻击的判断-canstartattack">B. 怪物能否开始攻击的判断 (<code>CanStartAttack</code>)</h4>
<p><strong>文件</strong>: Creature.cpp (第1865行)</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#66d9ef">bool</span> Creature<span style="color:#f92672">::</span>CanStartAttack(Unit <span style="color:#66d9ef">const</span><span style="color:#f92672">*</span> who, <span style="color:#66d9ef">bool</span> force) <span style="color:#66d9ef">const</span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (IsCivilian())
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> false;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 免疫检查
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> ((IsImmuneToNPC() <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">!</span>who<span style="color:#f92672">-&gt;</span>HasUnitFlag(UNIT_FLAG_PLAYER_CONTROLLED))
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">||</span> (IsImmuneToPC() <span style="color:#f92672">&amp;&amp;</span> who<span style="color:#f92672">-&gt;</span>HasUnitFlag(UNIT_FLAG_PLAYER_CONTROLLED)))
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> false;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 不攻击非战斗宠物
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> (who<span style="color:#f92672">-&gt;</span>GetTypeId() <span style="color:#f92672">==</span> TYPEID_UNIT <span style="color:#f92672">&amp;&amp;</span> who<span style="color:#f92672">-&gt;</span>GetCreatureType() <span style="color:#f92672">==</span> CREATURE_TYPE_NON_COMBAT_PET)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> false;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Z轴距离检查
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>CanFly() <span style="color:#f92672">&amp;&amp;</span> (GetDistanceZ(who) <span style="color:#f92672">&gt;</span> CREATURE_Z_ATTACK_RANGE <span style="color:#f92672">+</span> m_CombatDistance))
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> false;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>force)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 目标可接受性检查
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>_IsTargetAcceptable(who))
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> false;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 中立或距离检查
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span> (IsNeutralToAll() <span style="color:#f92672">||</span> <span style="color:#f92672">!</span>IsWithinDistInMap(who, GetAttackDistance(who) <span style="color:#f92672">+</span> m_CombatDistance))
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> false;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 基本攻击能力检查
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>CanCreatureAttack(who, force))
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> false;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 灰色怪物不主动攻击配置
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> (CheckNoGrayAggroConfig(who<span style="color:#f92672">-&gt;</span>GetLevelForTarget(<span style="color:#66d9ef">this</span>), GetLevelForTarget(who)))
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> false;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 视线检查
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">IsWithinLOSInMap</span>(who);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="2-开始攻击的核心函数-engagewithtarget">2. 开始攻击的核心函数 (<code>EngageWithTarget</code>)</h3>
<p><strong>文件</strong>: Unit.cpp (第8289行)</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#66d9ef">void</span> Unit<span style="color:#f92672">::</span>EngageWithTarget(Unit<span style="color:#f92672">*</span> enemy)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>enemy)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (CanHaveThreatList())
</span></span><span style="display:flex;"><span>        m_threatManager.AddThreat(enemy, <span style="color:#ae81ff">0.0f</span>, <span style="color:#66d9ef">nullptr</span>, true, true);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">SetInCombatWith</span>(enemy);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>这个函数是怪物设置目标的关键入口点，它会将目标添加到威胁列表中。</p>
<h3 id="3-威胁系统-threatmanageraddthreat">3. 威胁系统 (<code>ThreatManager::AddThreat</code>)</h3>
<p><strong>文件</strong>: ThreatManager.cpp (第356行开始)</p>
<p>这是最核心的目标设置机制：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#66d9ef">void</span> ThreatManager<span style="color:#f92672">::</span>AddThreat(Unit<span style="color:#f92672">*</span> target, <span style="color:#66d9ef">float</span> amount, SpellInfo <span style="color:#66d9ef">const</span><span style="color:#f92672">*</span> spell, <span style="color:#66d9ef">bool</span> ignoreModifiers, <span style="color:#66d9ef">bool</span> ignoreRedirects)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 第一步: 检查法术是否有NO_THREAT属性
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> (spell)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (spell<span style="color:#f92672">-&gt;</span>HasAttribute(SPELL_ATTR1_NO_THREAT))
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>_owner<span style="color:#f92672">-&gt;</span>IsEngaged() <span style="color:#f92672">&amp;&amp;</span> spell<span style="color:#f92672">-&gt;</span>HasAttribute(SPELL_ATTR3_NO_INITIAL_AGGRO))
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 确保进入战斗状态 (威胁意味着战斗!)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>_owner<span style="color:#f92672">-&gt;</span>GetCombatManager().SetInCombatWith(target))
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 检查是否已有威胁条目
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">auto</span> it <span style="color:#f92672">=</span> _myThreatListEntries.find(target<span style="color:#f92672">-&gt;</span>GetGUID());
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (it <span style="color:#f92672">!=</span> _myThreatListEntries.end())
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 已存在，增加威胁值
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        ThreatReference<span style="color:#f92672">*</span> <span style="color:#66d9ef">const</span> ref <span style="color:#f92672">=</span> it<span style="color:#f92672">-&gt;</span>second;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (ref<span style="color:#f92672">-&gt;</span>IsOnline())
</span></span><span style="display:flex;"><span>            ref<span style="color:#f92672">-&gt;</span>AddThreat(amount);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 创建新的威胁引用并添加到威胁管理器
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    ThreatReference<span style="color:#f92672">*</span> ref <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ThreatReferenceImpl(<span style="color:#66d9ef">this</span>, target);
</span></span><span style="display:flex;"><span>    PutThreatListRef(target<span style="color:#f92672">-&gt;</span>GetGUID(), ref);
</span></span><span style="display:flex;"><span>    target<span style="color:#f92672">-&gt;</span>GetThreatManager().PutThreatenedByMeRef(_owner<span style="color:#f92672">-&gt;</span>GetGUID(), ref);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    ref<span style="color:#f92672">-&gt;</span>UpdateOffline();
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (ref<span style="color:#f92672">-&gt;</span>IsOnline())
</span></span><span style="display:flex;"><span>        ref<span style="color:#f92672">-&gt;</span>AddThreat(amount);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 如果没有当前受害者，更新受害者
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>_currentVictimRef)
</span></span><span style="display:flex;"><span>        UpdateVictim();
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">ProcessAIUpdates</span>();
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="4-目标选择机制-selectvictim">4. 目标选择机制 (<code>SelectVictim</code>)</h3>
<p><strong>文件</strong>: Creature.cpp (第1124行)</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>Unit<span style="color:#f92672">*</span> Creature<span style="color:#f92672">::</span>SelectVictim()
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    Unit<span style="color:#f92672">*</span> target <span style="color:#f92672">=</span> <span style="color:#66d9ef">nullptr</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (CanHaveThreatList())
</span></span><span style="display:flex;"><span>        target <span style="color:#f92672">=</span> GetThreatManager().GetCurrentVictim();
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span> <span style="color:#a6e22e">if</span> (<span style="color:#f92672">!</span>HasReactState(REACT_PASSIVE))
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 宠物逻辑
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        target <span style="color:#f92672">=</span> getAttackerForHelper();
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>target <span style="color:#f92672">&amp;&amp;</span> IsSummon())
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> (Unit<span style="color:#f92672">*</span> owner <span style="color:#f92672">=</span> ToTempSummon()<span style="color:#f92672">-&gt;</span>GetOwner())
</span></span><span style="display:flex;"><span>            {
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span> (owner<span style="color:#f92672">-&gt;</span>IsInCombat())
</span></span><span style="display:flex;"><span>                    target <span style="color:#f92672">=</span> owner<span style="color:#f92672">-&gt;</span>getAttackerForHelper();
</span></span><span style="display:flex;"><span>                <span style="color:#75715e">// ... 更多宠物逻辑
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (target <span style="color:#f92672">&amp;&amp;</span> _IsTargetAcceptable(target) <span style="color:#f92672">&amp;&amp;</span> CanCreatureAttack(target))
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>HasSpellFocus())
</span></span><span style="display:flex;"><span>            SetInFront(target);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> target;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nullptr</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="5-ai更新循环中的目标更新">5. AI更新循环中的目标更新</h3>
<p><strong>文件</strong>: CreatureAI.cpp (第240行)</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#66d9ef">bool</span> CreatureAI<span style="color:#f92672">::</span>UpdateVictim()
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>IsEngaged())
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> false;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>me<span style="color:#f92672">-&gt;</span>IsAlive())
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        EngagementOver();
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> false;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>me<span style="color:#f92672">-&gt;</span>HasReactState(REACT_PASSIVE))
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (Unit<span style="color:#f92672">*</span> victim <span style="color:#f92672">=</span> me<span style="color:#f92672">-&gt;</span>SelectVictim())
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> (victim <span style="color:#f92672">!=</span> me<span style="color:#f92672">-&gt;</span>GetVictim())
</span></span><span style="display:flex;"><span>                AttackStart(victim);  <span style="color:#75715e">// 这里会触发目标切换
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> me<span style="color:#f92672">-&gt;</span>GetVictim() <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nullptr</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// ... 被动状态处理
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">return</span> true;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="6-特殊触发情况">6. 特殊触发情况</h3>
<h4 id="a-副本中的定期战斗脉冲">A. 副本中的定期战斗脉冲</h4>
<p><strong>文件</strong>: Creature.cpp (第785行)</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#75715e">// 如果启用了定期战斗脉冲且怪物在战斗中且在副本中
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">if</span> (m_combatPulseDelay <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span> <span style="color:#f92672">&amp;&amp;</span> IsEngaged() <span style="color:#f92672">&amp;&amp;</span> GetMap()<span style="color:#f92672">-&gt;</span>IsDungeon())
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// ... 定时逻辑
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    Map<span style="color:#f92672">::</span>PlayerList <span style="color:#66d9ef">const</span><span style="color:#f92672">&amp;</span> players <span style="color:#f92672">=</span> GetMap()<span style="color:#f92672">-&gt;</span>GetPlayers();
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">auto</span><span style="color:#f92672">&amp;</span> player : players)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (player<span style="color:#f92672">-&gt;</span>IsAlive() <span style="color:#f92672">&amp;&amp;</span> IsHostileTo(player))
</span></span><span style="display:flex;"><span>            EngageWithTarget(player);  <span style="color:#75715e">// 强制将玩家设为目标
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h4 id="b-所有者战斗交互">B. 所有者战斗交互</h4>
<p><strong>文件</strong>: CreatureAI.cpp (第126行)</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#66d9ef">void</span> CreatureAI<span style="color:#f92672">::</span>OnOwnerCombatInteraction(Unit<span style="color:#f92672">*</span> target)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>target <span style="color:#f92672">||</span> <span style="color:#f92672">!</span>me<span style="color:#f92672">-&gt;</span>IsAlive())
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>me<span style="color:#f92672">-&gt;</span>HasReactState(REACT_PASSIVE) <span style="color:#f92672">&amp;&amp;</span> me<span style="color:#f92672">-&gt;</span>CanStartAttack(target, true))
</span></span><span style="display:flex;"><span>        me<span style="color:#f92672">-&gt;</span>EngageWithTarget(target);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="总结">总结</h3>
<p>怪物将玩家设置为target的主要触发点：</p>
<ol>
<li><strong>视线检测</strong> - 玩家进入怪物攻击范围触发<code>MoveInLineOfSight</code></li>
<li><strong>威胁系统</strong> - 通过<code>AddThreat</code>函数将玩家添加到威胁列表</li>
<li><strong>目标选择</strong> - <code>SelectVictim</code>根据威胁列表选择最高威胁目标</li>
<li><strong>AI更新</strong> - 在每次AI更新中通过<code>UpdateVictim</code>刷新当前目标</li>
<li><strong>特殊机制</strong> - 副本脉冲、宠物辅助、法术伤害等特殊情况</li>
</ol>
<p>这整个系统确保了怪物能够智能地选择和切换攻击目标，同时保持了战斗的流畅性和逻辑性。</p>

</main>

  <footer>
  
  
  </footer>
  </body>
</html>

